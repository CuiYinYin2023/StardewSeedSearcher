<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星露谷物语 - 脆音音种子搜索器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input[type="number"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .condition-config {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .btn-add-condition {
            padding: 10px 20px;
            background: #75d378;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-add-condition:hover {
            background: #64b867;
        }

        .conditions-container {
            margin-bottom: 15px;
        }

        .condition-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            padding: 12px;
        }

        .condition-row select,
        .condition-row input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            text-align: center; 
        }

        .condition-row select {
            flex: 0 0 100px;
        }

        .condition-row input {
            flex: 1;
            min-width: 80px;
        }

        .condition-grid {
            padding: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 10px;
        }

        .btn-remove {
            padding: 6px 12px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        .btn-remove:hover {
            background-color: #cc0000;
        }

        .error-message {
            color: #f44336;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: #ffebee;
            border-radius: 4px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .btn-search {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }

        .btn-search:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-search:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            display: none;
            margin-top: 20px;
        }

        .progress-bar-container {
            background: #f0f0f0;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .results-section {
            margin-top: 20px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .results-header h3 {
            color: #667eea;
        }

        .seed-list {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }

        .seed-item {
            background: white;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: flex-start;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .status-searching {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .status-complete {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .connection-status.connected { background: #4caf50; color: white; }
        .connection-status.disconnected { background: #f44336; color: white; }
        .connection-status.connecting { background: #ff9800; color: white; }

        .bilibili-link, .bilibili-link-charge {
            position: fixed;
            left: 20px;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bilibili-link {
            bottom: 75px;
            background: #00a1d6;
            box-shadow: 0 4px 15px rgba(0, 161, 214, 0.4);
        }

        .bilibili-link:hover {
            transform: translateY(-2px);
            background: #0090c1;
        }

        .bilibili-link-charge {
            bottom: 20px;
            background: rgb(247, 186, 51);
            box-shadow: 0 4px 15px rgba(247, 186, 51, 0.4);
        }

        .bilibili-link-charge:hover {
            transform: translateY(-2px);
            background: rgb(237, 176, 41);
        }

        .footer {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-top: 20px;
        }

        .footer h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .footer ul {
            list-style: none;
            padding-left: 0;
        }

        .footer li {
            padding: 8px 0;
            color: #666;
            font-size: 0.95em;
            border-bottom: 1px solid #f0f0f0;
        }

        .footer li::before {
            content: "📝 ";
            margin-right: 8px;
        }

        .footer .placeholder-text {
            color: #999;
            font-style: italic;
        }

        .guide-details {
            border: 2px solid rgb(247, 232, 199);
            border-radius: 8px;
            margin-bottom: 25px;
            padding: 12px 20px;
            background-color: rgb(247, 186, 51);
            transition: background-color 0.3s;
        }

        .guide-details[open] {
            background-color: rgb(247, 186, 51);
        }

        .guide-summary {
            font-weight: 600;
            color: #ffffff;
            cursor: pointer;
            outline: none; /* 移除点击时的焦点框 */
        }
        
        .guide-summary::-webkit-details-marker {
            display: none; /* 隐藏 Chrome/Safari 的默认箭头 */
        }

        .guide-summary {
            list-style: none; /* 隐藏 Firefox 的默认箭头 */
        }

        .guide-summary::before {
            content: '▶';
            display: inline-block;
            font-size: 0.8em;
            margin-right: 8px;
            transition: transform 0.2s;
            vertical-align: middle;
        }

        .guide-details[open] > .guide-summary::before {
            transform: rotate(90deg);
        }

        .guide-list {
            margin-top: 15px;
            padding-left: 25px;
            color: #ffffff;
            font-size: 0.95em;
            border-top: 1px solid #ececec;
            padding-top: 15px;
        }

        .guide-list li {
            margin-bottom: 8px;
        }
        .guide-list li:last-child {
            margin-bottom: 0;
        }
        .form-separator {
            border: none;
            height: 1px;
            background-color: #e0e0e0;
            margin: 25px 0;
        }

        .form-group--inline {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .form-group--inline label {
            margin-bottom: 0; /* 移除默认的label下边距 */
            white-space: nowrap; /* 防止文字换行 */
            flex-shrink: 0; /* 防止标签文字被压缩 */
        }

        /* 侧边栏遮罩 */
        .sidebar-overlay {
            display: none !important;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* 侧边栏面板 */
        .sidebar-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            z-index: 2001;
            overflow-y: auto;
            transition: right 0.3s;
            padding: 30px;
            pointer-events: auto; /* 确保侧边栏可以点击 */
            cursor: default; /* 侧边栏内恢复默认鼠标 */
        }

        .sidebar-panel.active {
            right: 0;
        }

        .sidebar-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .sidebar-close:hover {
            color: #333;
        }

        .sidebar-title {
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }

        .sidebar-seed {
            text-align: center;
            font-size: 1.2em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-copy-seed {
            background: #667eea;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .btn-copy-seed:hover {
            background: #5568d3;
        }

        .sidebar-footer {
            text-align: center;
            font-size: 0.9em;
            color: #999;
            margin: 15px 0;
        }

        .sidebar-footer a {
            color: #667eea;
            text-decoration: none;
        }

        .sidebar-section {
            margin-top: 25px;
        }

        .sidebar-section h4 {
            text-align: center;
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .weather-season {
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .weather-season-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }

        .weather-days {
            color: #666;
            line-height: 1.6;
        }

        .green-rain {
            color: #4caf50;
            font-weight: 600;
        }

        /* 按钮组 */
        .seed-item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-detail, .btn-copy {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-detail {
            background: #667eea;
            color: white;
        }

        .btn-detail:hover {
            background: #5568d3;
        }

        .btn-copy {
            background: #4caf50;
            color: white;
        }

        .btn-copy:hover {
            background: #45a049;
        }

        .copy-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .copy-toast.show {
            opacity: 1;
        }

        .fairy-condition-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .fairy-condition-row select,
        .fairy-condition-row input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .fairy-condition-row input[type="number"] {
            width: 80px;
        }

        .fairy-condition-row select {
            width: 100px;
        }     

        .minechest-condition-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .minechest-floor {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .minechest-item {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .minechest-item.matched {
            color: #28a745;
            font-weight: bold;
        }

        .minechest-item.unmatched {
            color: #dc3545;
        }   
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">连接中...</div>

    <div class="container">
        <div class="header">
            <h1>🌾 星露谷物语</h1>
            <div class="subtitle">脆音音种子搜索器 Web 版</div>
        </div>

        <div class="card">
            <form id="searchForm">
                <details class="guide-details">
                    <summary class="guide-summary">操作指南</summary>
                    <ul class="guide-list">
                        <li>如果搜索无响应或出现 Bug，请<strong>完全关闭黑色的程序窗口</strong>和此页面，然后再重新运行start.bat。仅刷新此页面可能无法解决问题。</li>
                        <li>目前没有停止搜索功能，可以关掉黑色程序窗口强行停止。</li>
                        <!-- 未来可以填写更多说明 -->
                    </ul>
                </details>
                <div class="form-row">
                    <div class="form-group">
                        <label for="startSeed">起始种子</label>
                        <input type="number" id="startSeed" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="searchRange">搜索范围</label>
                        <input type="number" id="searchRange" value="100000" min="1" required>
                    </div>                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="loopSearch" checked>
                        <label for="loopSearch">循环搜索</label>
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="useLegacy">
                    <label for="useLegacy">使用旧随机模式</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="weatherEnabled" checked>
                    <label for="weatherEnabled">启用天气预测</label>
                </div>
                <div class="condition-config" id="weatherConfig">
                    <h4 style="margin-bottom: 15px;">天气筛选条件</h4>
                    <!-- 新的容器,用来放所有可编辑的条件行 -->
                    <div class="conditions-container" id="conditionsContainer">  
                        <!-- 字段标签 -->
                        <div class="condition-grid" style="margin-bottom: 5px;">
                            <div style="font-size: 13px; color: #000000; text-align: center;">季节</div>
                            <div style="font-size: 13px; color: #000000; text-align: center;">起始日期</div>
                            <div style="font-size: 13px; color: #000000; text-align: center;">结束日期</div>
                            <div style="font-size: 13px; color: #000000; text-align: center;">最小雨天数量</div>
                            <div style="font-size: 13px; color: #000000; text-align: center;"></div>
                        </div>                  
                        <!-- 第一个编辑框(初始存在) -->
                        <div class="condition-row">                          
                            <select>
                                <option value="Spring">春季</option>
                                <option value="Summer">夏季</option>
                                <option value="Fall">秋季</option>
                            </select>
                            <input type="number" placeholder="起始 (1-28)" min="1" max="28" value="1">
                            <input type="number" placeholder="结束 (1-28)" min="1" max="28" value="28">
                            <input type="number" placeholder="最少雨天" min="1" value="10">
                            <button type="button" class="btn-remove" onclick="removeCondition(0)">删除</button>
                        </div>
                    </div>
                    
                    <button type="button" class="btn-add-condition" onclick="addCondition()">添加条件</button>
                    
                    <div class="error-message" id="conditionError"></div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="fairyEnabled" checked>
                    <label for="fairyEnabled">启用仙子预测</label>
                </div>
                <div class="condition-config" id="fairyConfig">
                    <h4 style="margin-bottom: 15px;">仙子筛选条件</h4>
                    
                    <div class="fairy-conditions-container" id="fairyConditionsContainer">
                        <div class="fairy-condition-row" data-index="0">
                            <label>年</label>
                            <input type="number" min="1" max="10" value="1" class="fairy-year" onchange="updateFairyCondition(0)">
                            <label>季</label>
                            <select class="fairy-season" onchange="updateFairyCondition(0)">
                                <option value="Spring">春</option>
                                <option value="Summer">夏</option>
                                <option value="Fall">秋</option>
                            </select>
                            <label>日</label>
                            <input type="number" min="1" max="28" value="1" class="fairy-day" onchange="updateFairyCondition(0)">
                            <button type="button" class="btn-remove" onclick="removeFairyCondition(0)">删除</button>
                        </div>
                    </div>
                    
                    <template id="fairyConditionTemplate">
                        <div class="fairy-condition-row">
                            <label>年</label>
                            <input type="number" min="1" max="10" value="1" class="fairy-year">
                            <label>季</label>
                            <select class="fairy-season">
                                <option value="Spring">春</option>
                                <option value="Summer">夏</option>
                                <option value="Fall">秋</option>
                            </select>
                            <label>日</label>
                            <input type="number" min="1" max="28" value="1" class="fairy-day">
                            <button type="button" class="btn-remove">删除</button>
                        </div>
                    </template>
                    
                    <button type="button" class="btn-add-condition" onclick="addFairyCondition()">添加条件</button>
                    
                    <div class="error-message" id="fairyConditionError"></div>
                </div>

                <!-- 矿井宝箱部分 -->
                <div class="checkbox-group">
                    <input type="checkbox" id="mineChestEnabled" checked>
                    <label for="mineChestEnabled">启用矿井宝箱预测</label>
                </div>
                <div class="condition-config" id="mineChestConfig">
                    <h4 style="margin-bottom: 15px;">矿井宝箱筛选条件</h4>
                    
                    <div class="minechest-conditions-container" id="mineChestConditionsContainer">
                        
                        <!-- 第一个条件行 -->
                        <div class="minechest-condition-row" data-index="0">
                            <select class="minechest-floor" onchange="onFloorChange(0)">
                                <option value="10">10层</option>
                                <option value="20">20层</option>
                                <option value="50">50层</option>
                                <option value="60">60层</option>
                                <option value="80">80层</option>
                                <option value="90">90层</option>
                                <option value="110" selected>110层</option>
                            </select>
                            <select class="minechest-item" onchange="updateMineChestCondition(0)">
                                <!-- 动态填充物品列表 -->
                            </select>
                            <button type="button" class="btn-remove" onclick="removeMineChestCondition(0)">删除</button>
                        </div>
                    </div>
                    
                    <template id="mineChestConditionTemplate">
                        <div class="minechest-condition-row">
                            <select class="minechest-floor">
                                <option value="10">10层</option>
                                <option value="20">20层</option>
                                <option value="50">50层</option>
                                <option value="60">60层</option>
                                <option value="80">80层</option>
                                <option value="90">90层</option>
                                <option value="110">110层</option>
                            </select>
                            <select class="minechest-item">
                                <!-- 动态填充物品列表 -->
                            </select>
                            <button type="button" class="btn-remove">删除</button>
                        </div>
                    </template>
                    
                    <button type="button" class="btn-add-condition" onclick="addMineChestCondition()">添加条件</button>
                    
                    <div class="error-message" id="mineChestConditionError"></div>
                </div>

                <hr class="form-separator">
                <div class="form-group form-group--inline">
                    <label for="outputLimit">最大种子数量 (达到数量后将提前停止搜索，不建议太高)</label>
                    <input type="number" id="outputLimit" value="20" min="1" required>
                </div>

                <button type="submit" class="btn-search" id="searchBtn">🔍 开始搜索</button>
            </form>

            <div class="progress-section" id="progressSection">
                <div class="status-message status-searching" id="statusMessage">正在搜索中...</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="checkedCount">0</div>
                        <div class="stat-label">已检查</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="foundCount">0</div>
                        <div class="stat-label">已找到</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="speed">0</div>
                        <div class="stat-label">种子/秒</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="elapsed">0.0s</div>
                        <div class="stat-label">已用时</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <h3>搜索结果</h3>
                <span id="resultsSummary"></span>
            </div>
            <div class="seed-list" id="seedList">
                <div class="empty-state">暂无结果</div>
            </div>
        </div>

        <div class="card footer">
            <h3>🚀 脆音音的后续开发计划</h3>
            <ul>
                <li><span class="placeholder-text">更多功能：猪车、沙漠节商人、怪物层、春1菜品、垃圾桶、晶球、齐先生任务、矮人雕像矿+1buff、混合献祭包等</span></li>
            </ul>
        </div>
    </div>

    <!-- 侧边栏 -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <div class="sidebar-panel" id="sidebarPanel">
        <button class="sidebar-close" onclick="closeSidebar()">✕</button>
        <div class="sidebar-title">种子简介</div>
        <div class="sidebar-seed">
            <span id="sidebarMode"></span>种子号：<span id="sidebarSeedNumber"></span>
            <!-- <button class="btn-copy-seed" id="btnCopySeed">📋</button> -->
        </div>
        <div class="sidebar-footer">
            星露谷搜种器 by<a href="https://space.bilibili.com/349111916" target="_blank">脆音音</a>
        </div>

        <!-- 添加雨天部分 -->
        <div class="sidebar-section" id="weatherSection">
            <h4>雨天</h4>
            <div id="sidebarWeatherContent"></div>
        </div>

        <!-- 添加仙子部分 -->
        <div class="sidebar-section" id="fairySection">
            <h4>仙子</h4>
            <div id="sidebarFairyContent"></div>
        </div>

        <!-- 添加矿井宝箱部分 -->
        <div class="sidebar-section" id="mineChestSection">
            <h4>矿井宝箱</h4>
            <div id="sidebarMineChestContent"></div>
        </div>
    </div>

    <!-- 复制提示 -->
    <div class="copy-toast" id="copyToast">已复制</div>

    <a href="https://space.bilibili.com/349111916" target="_blank" class="bilibili-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.813 4.653h.854c1.51.054 2.769.578 3.773 1.574 1.004.995 1.524 2.249 1.56 3.76v7.36c-.036 1.51-.556 2.769-1.56 3.773s-2.262 1.524-3.773 1.56H5.333c-1.51-.036-2.769-.556-3.773-1.56S.036 18.858 0 17.347v-7.36c.036-1.511.556-2.765 1.56-3.76 1.004-.996 2.262-1.52 3.773-1.574h.774l-1.174-1.12a1.234 1.234 0 0 1-.373-.906c0-.356.124-.658.373-.907l.027-.027c.267-.249.573-.373.92-.373.347 0 .653.124.92.373L9.653 4.44c.071.071.134.142.187.213h4.267a.836.836 0 0 1 .16-.213l2.853-2.747c.267-.249.573-.373.92-.373.347 0 .662.151.929.4.267.249.391.551.391.907 0 .355-.124.657-.373.906zM5.333 7.24c-.746.018-1.373.276-1.88.773-.506.498-.769 1.13-.786 1.894v7.52c.017.764.28 1.395.786 1.893.507.498 1.134.756 1.88.773h13.334c.746-.017 1.373-.275 1.88-.773.506-.498.769-1.129.786-1.893v-7.52c-.017-.765-.28-1.396-.786-1.894-.507-.497-1.134-.755-1.88-.773zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c0-.373.129-.689.386-.947.258-.257.574-.386.947-.386zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373Z"/>
        </svg>
        联系作者
    </a>

    <a href="https://b23.tv/LSj8aCw" target="_blank" class="bilibili-link-charge">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17.813 4.653h.854c1.51.054 2.769.578 3.773 1.574 1.004.995 1.524 2.249 1.56 3.76v7.36c-.036 1.51-.556 2.769-1.56 3.773s-2.262 1.524-3.773 1.56H5.333c-1.51-.036-2.769-.556-3.773-1.56S.036 18.858 0 17.347v-7.36c.036-1.511.556-2.765 1.56-3.76 1.004-.996 2.262-1.52 3.773-1.574h.774l-1.174-1.12a1.234 1.234 0 0 1-.373-.906c0-.356.124-.658.373-.907l.027-.027c.267-.249.573-.373.92-.373.347 0 .653.124.92.373L9.653 4.44c.071.071.134.142.187.213h4.267a.836.836 0 0 1 .16-.213l2.853-2.747c.267-.249.573-.373.92-.373.347 0 .662.151.929.4.267.249.391.551.391.907 0 .355-.124.657-.373.906zM5.333 7.24c-.746.018-1.373.276-1.88.773-.506.498-.769 1.13-.786 1.894v7.52c.017.764.28 1.395.786 1.893.507.498 1.134.756 1.88.773h13.334c.746-.017 1.373-.275 1.88-.773.506-.498.769-1.129.786-1.893v-7.52c-.017-.765-.28-1.396-.786-1.894-.507-.497-1.134-.755-1.88-.773zM8 11.107c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c0-.373.129-.689.386-.947.258-.257.574-.386.947-.386zm8 0c.373 0 .684.124.933.373.25.249.383.569.4.96v1.173c-.017.391-.15.711-.4.96-.249.25-.56.374-.933.374s-.684-.125-.933-.374c-.25-.249-.383-.569-.4-.96V12.44c.017-.391.15-.711.4-.96.249-.249.56-.373.933-.373Z"/>
        </svg>
        催更作者
    </a>

    <script>
        let ws = null;
        let foundSeeds = [];
        let conditions = [];
        let currentSearchUseLegacy = false;
        let seedDetailsCache = {};
        let nextStartSeed = 0;
        let fairyConditions = [];
        let nextFairyIndex = 1;
        let mineChestConditions = [];
        let nextMineChestIndex = 1;

        const elements = {
            form: document.getElementById('searchForm'),
            searchBtn: document.getElementById('searchBtn'),
            progressSection: document.getElementById('progressSection'),
            resultsSection: document.getElementById('resultsSection'),
            progressBar: document.getElementById('progressBar'),
            statusMessage: document.getElementById('statusMessage'),
            checkedCount: document.getElementById('checkedCount'),
            foundCount: document.getElementById('foundCount'),
            speed: document.getElementById('speed'),
            elapsed: document.getElementById('elapsed'),
            seedList: document.getElementById('seedList'),
            resultsSummary: document.getElementById('resultsSummary'),
            connectionStatus: document.getElementById('connectionStatus'),
            weatherEnabled: document.getElementById('weatherEnabled'),
            weatherConfig: document.getElementById('weatherConfig'),
            conditionsList: document.getElementById('conditionsList'),
            conditionError: document.getElementById('conditionError'),

            fairyEnabled: document.getElementById('fairyEnabled'),
            fairyConfig: document.getElementById('fairyConfig'),
            fairyConditionError: document.getElementById('fairyConditionError'),

            mineChestEnabled: document.getElementById('mineChestEnabled'),
            mineChestConfig: document.getElementById('mineChestConfig'),
            mineChestConditionError: document.getElementById('mineChestConditionError')
        };

        const MINE_CHEST_ITEMS = { 
            10: ["皮靴", "工作靴", "木剑", "铁制短剑", "疾风利剑", "股骨"],
            20: ["钢制轻剑", "木棒", "精灵之刃", "光辉戒指", "磁铁戒指"],
            50: ["冻土靴", "热能靴", "战靴", "镀银军刀", "海盗剑"],
            60: ["水晶匕首", "弯刀", "铁刃", "飞贼之胫", "木锤"],
            80: ["蹈火者靴", "黑暗之靴", "双刃大剑", "圣堂之刃", "长柄锤", "暗影匕首"],
            90: ["黑曜石之刃", "淬火阔剑", "蛇形邪剑", "骨剑", "骨化剑"],
            110: ["太空之靴", "水晶鞋", "钢刀", "巨锤"]
        };

        // 天气
        elements.weatherEnabled.addEventListener('change', (e) => {
            elements.weatherConfig.style.display = e.target.checked ? 'block' : 'none';
        });
        // 仙子
        elements.fairyEnabled.addEventListener('change', (e) => {
            elements.fairyConfig.style.display = e.target.checked ? 'block' : 'none';
        });
        // 混合矿井宝箱
        elements.mineChestEnabled.addEventListener('change', (e) => {
            elements.mineChestConfig.style.display = e.target.checked ? 'block' : 'none';
        });

        // 添加条件
        function addCondition() {
            const container = document.getElementById('conditionsContainer');
            
            const newRow = document.createElement('div');
            newRow.className = 'condition-row';
            newRow.innerHTML = `
                <select>
                    <option value="Spring">春季</option>
                    <option value="Summer">夏季</option>
                    <option value="Fall">秋季</option>
                </select>
                <input type="number" placeholder="起始 (1-28)" min="1" max="28" value="1">
                <input type="number" placeholder="结束 (1-28)" min="1" max="28" value="28">
                <input type="number" placeholder="最少雨天" min="1" value="10">
                <button type="button" class="btn-remove">删除</button>
            `;
            
            container.appendChild(newRow);
            
            // 添加删除事件
            newRow.querySelector('.btn-remove').addEventListener('click', function() {
                newRow.remove();
                syncConditions();
            });
            
            // 添加输入变化事件
            newRow.querySelectorAll('select, input').forEach(el => {
                el.addEventListener('change', syncConditions);
            });
            
            syncConditions();
            hideError();
        }

        // 同步条件数据（从DOM读取）
        function syncConditions() {
            const rows = document.querySelectorAll('.condition-row');
            conditions = Array.from(rows).map(row => {
                const inputs = row.querySelectorAll('select, input');
                return {
                    season: inputs[0].value,
                    startDay: parseInt(inputs[1].value) || 1,
                    endDay: parseInt(inputs[2].value) || 28,
                    minRain: parseInt(inputs[3].value) || 1
                };
            });
        }

        // 验证单个条件
        function validateCondition(condition) {
            if (!condition) return { valid: false, error: '条件数据缺失' };
            
            const { startDay, endDay, minRain } = condition;
            
            if (startDay < 1 || startDay > 28 || endDay < 1 || endDay > 28) {
                return { valid: false, error: '日期必须在 1-28 之间' };
            }
            
            if (startDay > endDay) {
                return { valid: false, error: '起始日期必须小于等于结束日期' };
            }
            
            const dayCount = endDay - startDay + 1;
            if (minRain < 1 || minRain > dayCount) {
                return { valid: false, error: `最少雨天数必须在 1-${dayCount} 之间` };
            }
            
            return { valid: true };
        }

        // 检查条件重叠
        function hasOverlap(newCondition, excludeIndex) {
            const seasonOffset = { 'Spring': 0, 'Summer': 28, 'Fall': 56 };
            const newStart = seasonOffset[newCondition.season] + newCondition.startDay;
            const newEnd = seasonOffset[newCondition.season] + newCondition.endDay;

            for (let i = 0; i < conditions.length; i++) {
                if (i === excludeIndex) continue;
                
                const cond = conditions[i];
                const start = seasonOffset[cond.season] + cond.startDay;
                const end = seasonOffset[cond.season] + cond.endDay;

                if (!(newEnd < start || end < newStart)) {
                    return true;
                }
            }
            return false;
        }

        // 显示错误
        function showError(message) {
            const errorDiv = document.getElementById('conditionError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            errorDiv.style.display = 'block'; 
        }

        // 隐藏错误
        function hideError() {
            const errorDiv = document.getElementById('conditionError');
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.classList.remove('show');
                errorDiv.style.display = 'none';  
            }
        }

        function addFairyCondition() {
            const container = document.getElementById('fairyConditionsContainer');
            const template = document.getElementById('fairyConditionTemplate');
            const index = nextFairyIndex++;
            
            // 克隆模板
            const clone = template.content.cloneNode(true);
            const row = clone.querySelector('.fairy-condition-row');
            row.setAttribute('data-index', index);
            
            // 绑定事件
            row.querySelector('.fairy-year').onchange = () => updateFairyCondition(index);
            row.querySelector('.fairy-season').onchange = () => updateFairyCondition(index);
            row.querySelector('.fairy-day').onchange = () => updateFairyCondition(index);
            row.querySelector('.btn-remove').onclick = () => removeFairyCondition(index);
            
            container.appendChild(clone);
            updateFairyCondition(index);
        }

        function updateFairyCondition(index) {
            const row = document.querySelector(`.fairy-condition-row[data-index="${index}"]`);
            if (!row) return;
            
            const year = parseInt(row.querySelector('.fairy-year').value) || 1;
            const season = row.querySelector('.fairy-season').value;
            const day = parseInt(row.querySelector('.fairy-day').value) || 1;
            
            fairyConditions[index] = { year, season, day };
        }

        function removeFairyCondition(index) {
            const row = document.querySelector(`.fairy-condition-row[data-index="${index}"]`);
            if (row) {
                row.remove();
                delete fairyConditions[index];
            }
        }

        function validateFairyCondition(condition) {
            const { year, day } = condition;
            
            if (year < 1 || year > 10) {
                return { valid: false, error: '年份必须在 1-10 之间' };
            }
            
            if (day < 1 || day > 28) {
                return { valid: false, error: '日期必须在 1-28 之间' };
            }
            
            return { valid: true };
        }

        function hasFairyDuplicate(newCondition, excludeIndex) {
            const validConditions = fairyConditions.filter((c, i) => c && i !== excludeIndex);
            
            for (let condition of validConditions) {
                if (condition.year === newCondition.year && 
                    condition.season === newCondition.season && 
                    condition.day === newCondition.day) {
                    return true;
                }
            }
            return false;
        }

        // 添加矿井宝箱条件
        function addMineChestCondition() {
            const container = document.getElementById('mineChestConditionsContainer');
            const template = document.getElementById('mineChestConditionTemplate');
            const index = nextMineChestIndex++;
            
            const clone = template.content.cloneNode(true);
            const row = clone.querySelector('.minechest-condition-row');
            row.setAttribute('data-index', index);
            
            const floorSelect = row.querySelector('.minechest-floor');
            const itemSelect = row.querySelector('.minechest-item');
            
            // 默认填充第一个楼层的物品
            populateItemOptions(itemSelect, 10);
            
            // 绑定事件
            floorSelect.onchange = () => onFloorChange(index);  // 使用新函数
            itemSelect.onchange = () => updateMineChestCondition(index);
            row.querySelector('.btn-remove').onclick = () => removeMineChestCondition(index);
            
            container.appendChild(clone);
            updateMineChestCondition(index);
        }

        // 更新矿井宝箱条件
        function updateMineChestCondition(index) {
            const row = document.querySelector(`.minechest-condition-row[data-index="${index}"]`);
            if (!row) return;
            
            const floor = parseInt(row.querySelector('.minechest-floor').value);
            const item = row.querySelector('.minechest-item').value;
            
            mineChestConditions[index] = { Floor: floor, ItemName: item };
        }

        // 删除矿井宝箱条件
        function removeMineChestCondition(index) {
            const row = document.querySelector(`.minechest-condition-row[data-index="${index}"]`);
            if (row) {
                row.remove();
                delete mineChestConditions[index];
            }
        }

        // 根据楼层填充物品选项
        function populateItemOptions(selectElement, floor) {
            selectElement.innerHTML = ''; // 清空现有选项
            const items = MINE_CHEST_ITEMS[floor] || [];
            
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                selectElement.appendChild(option);
            });
        }

        // 检查重复条件
        function hasMineChestDuplicate(newCondition, excludeIndex) {
            const validConditions = mineChestConditions.filter((c, i) => c && i !== excludeIndex);
            
            for (let condition of validConditions) {
                if (condition.floor === newCondition.floor && 
                    condition.ItemName === newCondition.ItemName) {
                    return true;
                }
            }
            return false;
        }

        // 处理楼层变化
        function onFloorChange(index) {
            const row = document.querySelector(`.minechest-condition-row[data-index="${index}"]`);
            if (!row) return;
            
            const floorSelect = row.querySelector('.minechest-floor');
            const itemSelect = row.querySelector('.minechest-item');
            const floor = parseInt(floorSelect.value);
            
            // 更新物品列表
            populateItemOptions(itemSelect, floor);
            
            // 更新条件
            updateMineChestCondition(index);
        }

        // 最大输出种子数量
        function updateOutputLimitMax() {
            const searchRangeInput = document.getElementById('searchRange');
            const outputLimitInput = document.getElementById('outputLimit');

            const range = parseInt(searchRangeInput.value) || 0;
            const limit = parseInt(outputLimitInput.value) || 0;

            if (range <= limit) {
                // 如果当前值超过了新的最大值，就把它降下来
                outputLimitInput.value = range;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 天气条件初始化
            const firstRow = document.querySelector('.condition-row');
            if (firstRow) {
                // 为第一行添加删除事件
                firstRow.querySelector('.btn-remove').addEventListener('click', function() {
                    firstRow.remove();
                    syncConditions();
                });
                
                // 为第一行添加输入变化事件
                firstRow.querySelectorAll('select, input').forEach(el => {
                    el.addEventListener('change', syncConditions);
                });
                
                syncConditions();
            }

            // 仙子条件初始化
            updateFairyCondition(0);

            // 矿井宝箱条件初始化
            const firstMineChestRow = document.querySelector('.minechest-condition-row[data-index="0"]');
            if (firstMineChestRow) {
                const floorSelect = firstMineChestRow.querySelector('.minechest-floor');
                const itemSelect = firstMineChestRow.querySelector('.minechest-item');
                
                // 设置默认楼层为 110
                floorSelect.value = '110';
                
                // 填充 110 层的物品列表
                populateItemOptions(itemSelect, 110);
                
                // 设置默认物品为"巨锤"
                itemSelect.value = '巨锤';
                
                // 绑定楼层变化事件
                floorSelect.onchange = () => onFloorChange(0);
                
                // 初始化条件
                updateMineChestCondition(0);
            }
        });

        // 监听起始种子修改,重置循环
        document.getElementById('startSeed').addEventListener('change', function() {
            nextStartSeed = parseInt(this.value) || 0;
        });

        // 监听搜索范围修改,重置循环
        document.getElementById('searchRange').addEventListener('change', function() {
            const startSeed = parseInt(document.getElementById('startSeed').value) || 0;
            nextStartSeed = startSeed;
        });

        // 监听循环搜索复选框
        document.getElementById('loopSearch').addEventListener('change', function() {
            if (!this.checked) {
                // 取消循环时重置
                const startSeed = parseInt(document.getElementById('startSeed').value) || 0;
                nextStartSeed = startSeed;
            }
        });

        // 让页面加载后，以及每次修改种子范围时，都更新这个最大值
        document.addEventListener('DOMContentLoaded', updateOutputLimitMax);
        document.getElementById('startSeed').addEventListener('input', updateOutputLimitMax);

        function connectWebSocket() {
            elements.connectionStatus.textContent = '连接中...';
            elements.connectionStatus.className = 'connection-status connecting';

            ws = new WebSocket('ws://localhost:5000/ws');

            ws.onopen = () => {
                elements.connectionStatus.textContent = '✓ 已连接';
                elements.connectionStatus.className = 'connection-status connected';
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onerror = () => {
                elements.connectionStatus.textContent = '✗ 连接失败';
                elements.connectionStatus.className = 'connection-status disconnected';
            };

            ws.onclose = () => {
                elements.connectionStatus.textContent = '✗ 未连接';
                elements.connectionStatus.className = 'connection-status disconnected';
                setTimeout(connectWebSocket, 5000);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'start':
                    foundSeeds = [];
                    elements.seedList.innerHTML = '';
                    elements.resultsSection.style.display = 'block';
                    break;

                case 'progress':
                    elements.checkedCount.textContent = data.checkedCount.toLocaleString();
                    elements.speed.textContent = data.speed.toLocaleString();
                    elements.elapsed.textContent = data.elapsed + 's';
                    const progressInt = Math.floor(data.progress);
                    elements.progressBar.style.width = progressInt + '%';
                    elements.progressBar.textContent = progressInt + '%';
                    break;

                case 'found':
                    foundSeeds.push(data.seed);
                    elements.foundCount.textContent = foundSeeds.length;
                    
                    // 缓存种子信息用于展示简介
                    if (data.details) {
                        seedDetailsCache[data.seed] = {
                            details: data.details,
                            enabled: data.enabledFeatures || {}  // 如果后端没发送，用空对象
                        };
                    }

                    if (foundSeeds.length <= 20) {
                        const seedItem = document.createElement('div');
                        seedItem.className = 'seed-item';
                        seedItem.innerHTML = `
                            <span>种子: ${data.seed}</span>
                            <div class="seed-item-actions">
                                <button class="btn-detail" onclick="showSeedDetail(${data.seed})">简介</button>
                                <button class="btn-copy" onclick="copySeed(${data.seed})">复制</button>
                            </div>
                        `;
                        elements.seedList.appendChild(seedItem);
                    }
                    
                    updateResultsSummary();
                    break;

                case 'complete':
                    elements.statusMessage.textContent = `搜索完成！找到 ${data.totalFound} 个符合条件的种子`;
                    elements.statusMessage.className = 'status-message status-complete';
                    elements.searchBtn.disabled = false;
                    elements.searchBtn.textContent = '🔍 开始搜索';

                    const loopSearch = document.getElementById('loopSearch').checked;
                    if (loopSearch) {
                        const searchRange = parseInt(document.getElementById('searchRange').value);
                        nextStartSeed += searchRange;
                        
                        if (nextStartSeed > 2147483647) {
                            document.getElementById('loopSearch').checked = false;
                            alert('已搜索完所有种子范围');
                        }
                    }

                    updateResultsSummary();
                    break;
            }
        }

        function updateResultsSummary() {
            const total = foundSeeds.length;
            const shown = Math.min(total, 20);
            elements.resultsSummary.textContent = `共找到 ${total} 个 (显示前 ${shown} 个)`;
        }
        elements.form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const loopSearch = document.getElementById('loopSearch').checked;
            const searchRange = parseInt(document.getElementById('searchRange').value);
            const useLegacy = document.getElementById('useLegacy').checked;
            currentSearchUseLegacy = useLegacy;  // 保存当前搜索模式
            const weatherEnabled = elements.weatherEnabled.checked;
            const outputLimit = parseInt(document.getElementById('outputLimit').value); // 读取输出数量
            const mineChestEnabled = elements.mineChestEnabled.checked;

            // 计算起始种子
            let startSeed = loopSearch && nextStartSeed > 0 
                ? nextStartSeed 
                : parseInt(document.getElementById('startSeed').value);

            // 更新输入框显示
            document.getElementById('startSeed').value = startSeed;
            
            // 计算结束种子,不超过最大值
            const endSeed = Math.min(startSeed + searchRange - 1, 2147483647);
            
            // 检查是否已到最大值
            if (startSeed >= 2147483647) {
                alert('已达到最大种子值,无法继续搜索');
                return;
            }

            // 检查搜索范围是否有效
            if (searchRange < 1) {
                alert('搜索范围必须大于0!');
                return;
            }

            // 天气条件验证
            if (weatherEnabled) {
                hideError();
                
                const validConditions = conditions.filter(c => c);
                
                if (validConditions.length === 0) {
                    showError('请至少添加一个条件');
                    return;
                }
                
                // 验证所有条件
                for (let i = 0; i < conditions.length; i++) {
                    const condition = conditions[i];
                    if (!condition) continue;
                    
                    const validation = validateCondition(condition);
                    if (!validation.valid) {
                        showError(`条件 ${i + 1}: ${validation.error}`);
                        return;
                    }
                    
                    if (hasOverlap(condition, i)) {
                        showError(`条件 ${i + 1}: 与其他条件的日期范围重叠`);
                        return;
                    }
                }
            }

            // 仙子条件验证
            const fairyEnabled = elements.fairyEnabled.checked;

            if (fairyEnabled) {
                const validFairyConditions = fairyConditions.filter(c => c);
                
                if (validFairyConditions.length === 0) {
                    alert('请至少添加一个仙子条件！');
                    return;
                }
                
                for (let i = 0; i < fairyConditions.length; i++) {
                    const condition = fairyConditions[i];
                    if (!condition) continue;
                    
                    const validation = validateFairyCondition(condition);
                    if (!validation.valid) {
                        alert(`仙子条件 ${i + 1}: ${validation.error}`);
                        return;
                    }
                    
                    if (hasFairyDuplicate(condition, i)) {
                        alert(`仙子条件 ${i + 1}: 与其他条件重复`);
                        return;
                    }
                }
            } 
            
            // 矿井宝箱验证
            if (mineChestEnabled) {
                const validMineChestConditions = mineChestConditions.filter(c => c);
                
                if (validMineChestConditions.length === 0) {
                    alert('请至少添加一个矿井宝箱条件！');
                    return;
                }
                
                for (let i = 0; i < mineChestConditions.length; i++) {
                    const condition = mineChestConditions[i];
                    if (!condition) continue;
                    
                    if (hasMineChestDuplicate(condition, i)) {
                        alert(`矿井宝箱条件 ${i + 1}: 与其他条件重复`);
                        return;
                    }
                }
            }

            // 显示进度区域
            elements.progressSection.style.display = 'block';
            elements.resultsSection.style.display = 'block';
            elements.searchBtn.disabled = true;
            elements.searchBtn.textContent = '搜索中...';
            
            // 更新状态消息(显示搜索范围)
            elements.statusMessage.textContent = `正在搜索: ${startSeed.toLocaleString()}-${endSeed.toLocaleString()}`;

            elements.statusMessage.className = 'status-message status-searching';
            elements.progressBar.style.width = '0%';
            elements.progressBar.textContent = '0%';

            elements.checkedCount.textContent = '0';
            elements.foundCount.textContent = '0';
            elements.speed.textContent = '0';
            elements.elapsed.textContent = '0.0s';

            // 发送搜索请求
            try {
                const weatherConditions = weatherEnabled ? conditions.map(c => ({
                    season: c.season,
                    startDay: c.startDay,
                    endDay: c.endDay,
                    minRainDays: c.minRain
                })) : [];

                const fairyConditionsData = fairyEnabled ? fairyConditions.filter(c => c).map(c => ({
                    year: c.year,
                    season: c.season,
                    day: c.day
                })) : [];

                // 在发送搜索请求时添加矿井宝箱数据
                const mineChestConditionsData = mineChestEnabled ? mineChestConditions.filter(c => c).map(c => ({
                    Floor: c.Floor,
                    ItemName: c.ItemName
                })) : [];

                const response = await fetch('http://localhost:5000/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        startSeed,
                        endSeed,
                        useLegacyRandom: useLegacy,
                        weatherConditions,
                        fairyConditions: fairyConditionsData,
                        MineChestConditions: mineChestConditionsData, 
                        outputLimit // 将输出数量添加到请求中
                    })
                });

                if (!response.ok) {
                    throw new Error('搜索请求失败');
                }
            } catch (error) {
                console.error('搜索错误:', error);
                alert('搜索失败,请确保后端服务正在运行!');
                elements.searchBtn.disabled = false;
                elements.searchBtn.textContent = '🔍 开始搜索';
            }
        });

        // 显示种子详情
        function showSeedDetail(seed) {
            const cached = seedDetailsCache[seed];
            if (!cached) return;
            
            const { details, enabled } = cached;
            
            document.getElementById('sidebarMode').textContent = currentSearchUseLegacy ? '旧随机' : '新随机';
            document.getElementById('sidebarSeedNumber').textContent = seed;
    
            // 只有启用了天气功能才显示
            if (enabled.weather && details.weather) {
                const seasonNames = ['春季', '夏季', '秋季'];
                const seasons = [
                    { name: seasonNames[0], days: details.weather.springRain, greenRainDay: null },
                    { name: seasonNames[1], days: details.weather.summerRain, greenRainDay: details.weather.greenRainDay },
                    { name: seasonNames[2], days: details.weather.fallRain, greenRainDay: null }
                ];
                
                let weatherHtml = '';  // 定义变量
                seasons.forEach(season => {
                    const count = season.days.length;
                    let daysText = '';
                    
                    if (count > 0) {
                        daysText = season.days.map(day => {
                            const isGreenRain = season.greenRainDay === day;
                            return isGreenRain ? `<span class="green-rain">${day}（绿雨）</span>` : day;
                        }).join(', ');
                    }
                    
                    weatherHtml += `
                        <div class="weather-season">
                            <div class="weather-season-title">${season.name}（${count}个）：</div>
                            <div class="weather-days">${count > 0 ? daysText : '无'}</div>
                        </div>
                    `;
                });
                
                document.getElementById('sidebarWeatherContent').innerHTML = weatherHtml;
                document.getElementById('weatherSection').style.display = 'block';
            } else {
                document.getElementById('weatherSection').style.display = 'none';
            }
            
            // 只有启用了仙子功能才显示
            if (enabled.fairy && details.fairy && details.fairy.days) {
                const seasonMap = { Spring: '春', Summer: '夏', Fall: '秋' };
                const fairyText = details.fairy.days.map(f => {
                    const prefix = f.year === 1 ? '' : `${f.year}年`;
                    return `${prefix}${seasonMap[f.season]}${f.day}`;
                }).join('、');
                
                const fairyHtml = `
                    <div class="weather-season">
                        <div class="weather-season-title">仙子（${details.fairy.days.length}个）：</div>
                        <div class="weather-days">${fairyText}</div>
                    </div>
                `;
                document.getElementById('sidebarFairyContent').innerHTML = fairyHtml;
                document.getElementById('fairySection').style.display = 'block';
            } else {
                document.getElementById('fairySection').style.display = 'none';
            }

        // 只有启用了矿井宝箱功能才显示
        if (enabled.mineChest && details.mineChest) {
            let chestHtml = '<div class="weather-season">';

            details.mineChest.forEach(item => {
                const matchIcon = item.matched ? '✓' : '✗';
                const matchClass = item.matched ? 'matched' : 'unmatched';
                chestHtml += `
                    <div class="minechest-item ${matchClass}">
                        <span>${matchIcon} ${item.floor}层：${item.item}</span>
                    </div>
                `;
            });
            chestHtml += '</div>';
            document.getElementById('sidebarMineChestContent').innerHTML = chestHtml;
            document.getElementById('mineChestSection').style.display = 'block';
        } else {
            document.getElementById('mineChestSection').style.display = 'none';
        }
            
            // 显示侧边栏
            document.getElementById('sidebarPanel').classList.add('active');
        }

        // 关闭侧边栏
        function closeSidebar() {
            document.getElementById('sidebarPanel').classList.remove('active');
        }

        // 复制种子号
        function copySeed(seed) {
            navigator.clipboard.writeText(seed).then(() => {
                showCopyToast();
            });
        }

        // 从侧边栏复制
        function copySeedFromSidebar() {
            console.log('复制按钮被点击了');
            const seed = document.getElementById('sidebarSeedNumber').textContent;
            console.log('种子号:', seed);
            navigator.clipboard.writeText(seed).then(() => {
                showCopyToast();
            });
        }

        // 显示复制提示
        function showCopyToast() {
            const toast = document.getElementById('copyToast');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        connectWebSocket();
    </script>
</body>
</html>